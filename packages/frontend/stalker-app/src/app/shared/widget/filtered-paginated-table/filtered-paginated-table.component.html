<div class="table-container tw-flex tw-flex-col">
  <!-- Search filter-->
  @switch (filterType) {
    @case ('tokens') {
      <ng-container *ngTemplateOutlet="tokenSearch"></ng-container>
    }
    @case ('fulltext') {
      <ng-container *ngTemplateOutlet="fulltextSearch"></ng-container>
    }
  }

  <table mat-table [dataSource]="_dataSource" class="tw-flex-1">
    <!-- Checkbox Column -->
    <ng-container matColumnDef="select">
      <th mat-header-cell *matHeaderCellDef>
        <mat-checkbox
          color="accent"
          (change)="$event ? masterToggle() : null"
          [checked]="selection.hasValue() && isAllSelected()"
          [indeterminate]="selection.hasValue() && !isAllSelected()"
        >
        </mat-checkbox>
      </th>
      <td mat-cell *matCellDef="let row" (click)="$event.stopPropagation()" class="check-box-cell">
        <mat-checkbox
          color="accent"
          (click)="$event.stopPropagation()"
          (change)="$event ? toggleSelectedRow(row) : null"
          [checked]="selection.isSelected(row)"
        >
        </mat-checkbox>
      </td>
    </ng-container>

    <ng-content></ng-content>

    @if (elementLinkActive) {
      <tr
        mat-row
        *matRowDef="let row; columns: columns"
        routerLinkActive="list-item-active"
        [routerLink]="[routerLinkPrefix, row._id ? row._id : row.id]"
        [queryParams]="queryParamsFunc != null ? queryParamsFunc(row) : undefined"
        class="rows"
      ></tr>
    }
    @if (!elementLinkActive) {
      <tr mat-row *matRowDef="let row; columns: columns" class="rows rows-inactive"></tr>
    }

    <tr class="mat-row nodata" *matNoDataRow>
      <td class="mat-cell" colspan="100%">
        {{ noDataMessage }}
      </td>
    </tr>
  </table>

  @if (isLoading) {
    <div>
      <mat-progress-bar mode="indeterminate" class="tw-flex-1" color="accent"></mat-progress-bar>
    </div>
  }

  <mat-paginator
    class="tw-flex-1"
    [length]="length"
    [pageSize]="pageSize"
    [pageSizeOptions]="pageSizeOptions"
    [pageIndex]="currentPage"
    showFirstLastButtons
    aria-label="Select page"
    (page)="pageChanged($event)"
  >
  </mat-paginator>
</div>

<ng-template #tokenSearch>
  <mat-form-field class="filter-chip-list" appearance="fill" [floatLabel]="'always'">
    <mat-label i18n="Search filter|Filter your search to get more precise results">Search filter</mat-label>
    <mat-chip-grid #chipList>
      @for (filter of filters; track filter) {
        <mat-chip-row (click)="editFilter($event, filter)" (removed)="removeFilter(filter)">
          {{ filter }}
          <button matChipRemove>
            <mat-icon>cancel</mat-icon>
          </button>
        </mat-chip-row>
      }
      <input
        tab-directive
        type="text"
        i18n-placeholder="New filter|Creating a new filter"
        placeholder="New filter..."
        #filterInput
        [formControl]="filterForm"
        [matAutocomplete]="auto"
        [matChipInputFor]="chipList"
        [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
        (matChipInputTokenEnd)="addFilter($event)"
        (click)="filterForm.setValue(filterForm.value ? filterForm.value : '')"
      />
    </mat-chip-grid>
    <mat-autocomplete
      placeholder="New filter..."
      #auto="matAutocomplete"
      (optionSelected)="selected($event)"
      [autoActiveFirstOption]="true"
    >
      @for (filter of filteredColumns$ | async; track filter) {
        <mat-option [value]="filter">
          {{ filter }}
        </mat-option>
      }
    </mat-autocomplete>
  </mat-form-field>
</ng-template>

<ng-template #fulltextSearch>
  <mat-form-field class="filter-chip-list" appearance="fill" [floatLabel]="'always'">
    <mat-label i18n="Search filter|Filter your search to get more precise results">Search filter</mat-label>

    <input
      matInput
      type="text"
      i18n-placeholder="New filter|Creating a new filter"
      placeholder="New filter..."
      #fulltextInput
      (keyup)="filtersChange.next([fulltextInput.value])"
    />
  </mat-form-field>
</ng-template>
