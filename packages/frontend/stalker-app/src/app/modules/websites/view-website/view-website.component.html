@if (website$ | async; as wsite) {
  <div class="tw-flex tw-items-center tw-px-4 tw-gap">
    <app-page-header
      [backRoute]="['..']"
      [parts]="[(projects$ | async | whereId: [wsite.projectId])?.name, wsite.url]"
    ></app-page-header>

    @if (wsite.blocked) {
      <app-blocked-pill-tag class="tw-mt-[9px]"></app-blocked-pill-tag>
    }

    <h1 [matTooltip]="wsite.ssl ? secureConnectionTooltip : insecureConnectionTooltip" class="secure-icon">
      @if (wsite.ssl) {
        <mat-icon> lock </mat-icon>
      } @else {
        <mat-icon> no_encryption </mat-icon>
      }
    </h1>
  </div>

  <div class="content-wrapper">
    <div class="content">
      <div class="website-overview">
        <mat-card id="sitemap">
          <mat-form-field class="search" appearance="fill" [floatLabel]="'always'" subscriptSizing="dynamic">
            <mat-label i18n="Search filter|Filter your search to get more precise results">Search filter</mat-label>

            <input
              matInput
              type="text"
              i18n-placeholder="Search site map|Search the website's site map"
              placeholder="Search site map"
              #fulltextInput
              (keyup)="sitemapFilterChange$.next(fulltextInput.value)"
            />
          </mat-form-field>
          <div class="independent-scroll">
            @for (path of sitemap$ | async; track $index) {
              <div class="endpoint" (click)="selectedEndpoint$.next(path)">
                <p
                  [matTooltip]="path"
                  matTooltipPosition="below"
                  matTooltipShowDelay="200"
                  [style]="path === selectedEndpoint ? 'text-decoration: underline;' : ''"
                >
                  {{ path }}
                </p>
              </div>
            }
            @if (!(sitemap$ | async)?.length) {
              <p class="no-data" i18n="no available data|No data available">No available data</p>
            }
          </div>
        </mat-card>
        <mat-card id="website-data">
          @if (endpointLoading) {
            <div
              class="tw-w-full tw-h-full tw-text-center tw-align-middle tw-flex tw-flex-row tw-items-center tw-justify-center"
            >
              <mat-spinner [color]="'accent'" class="spinner"></mat-spinner>
            </div>
          }
          @if (endpointData$ | async; as endpointData) {
            @if (!endpointLoading) {
              <div class="inline-endpoint">
                @for (field of endpointData.fields; track field) {
                  @if (field.type === 'text') {
                    @if (field.key === 'method') {
                      <div id="method">
                        <!-- <div class="label">{{ field.label }}</div> -->
                        <div class="data">{{ field.data }}</div>
                      </div>
                    }

                    @if (field.key === 'endpoint') {
                      <div id="endpoint">
                        <!-- <div class="label">{{ field.label }}</div> -->
                        <div class="data">{{ field.data }}</div>
                      </div>
                    }

                    @if (field.key === 'statusCode') {
                      <div id="status-code">
                        <app-status-code-pill-tag [statusCode]="field.data"></app-status-code-pill-tag>
                      </div>
                    }
                  }
                }
              </div>
              <mat-divider class="endpoint-data-divider"></mat-divider>
              <div class="endpoint-metadata-container">
                <div class="endpoint-metadata">
                  @for (field of endpointData.fields; track field) {
                    @if (
                      field.type === 'text' &&
                      field.key !== 'endpoint' &&
                      field.key !== 'method' &&
                      field.key !== 'statusCode'
                    ) {
                      <div class="endpoint-metadata-item">
                        <div class="label">{{ field.label }}</div>
                        <div class="data">{{ field.data }}</div>
                      </div>
                    }
                  }
                </div>
                <div class="timestamp-container">
                  <div
                    class="timestamp"
                    [matTooltip]="endpointData.created.valueOf() | humanizeDate: 'precise'"
                    matTooltipPosition="after"
                  >
                    {{ endpointData.created | timeAgo }}
                  </div>
                </div>
              </div>
            }
          } @else {
            @if (!endpointLoading) {
              <div
                class="tw-w-full tw-h-full tw-text-center tw-align-middle tw-flex tw-flex-row tw-items-center tw-justify-center"
              >
                <div class="no-data">
                  <span class="material-symbols-outlined no-data-icon"> search_insights </span>
                  <p i18n="select endpoint|select endpoint in sitemap">Select an endpoint in the site map</p>
                </div>
              </div>
            }
          }
        </mat-card>
        <mat-card id="preview">
          @if (wsite.previewImage) {
            Not supported yet
          } @else {
            <div
              class="tw-w-full tw-h-full tw-text-center tw-align-middle tw-flex tw-flex-row tw-items-center tw-justify-center"
            >
              <div class="no-data">
                <span class="material-symbols-outlined no-data-icon"> screenshot_monitor </span>
                <p i18n="No image preview|No image preview available for the moment">No image preview available</p>
              </div>
            </div>
          }
        </mat-card>
      </div>
      <mat-divider class="section-divider"></mat-divider>

      <findings-list [correlationKey]="wsite.correlationKey" [filterFindingKeys]="findingsFilterKeys"></findings-list>
    </div>
    <div #contextPanel class="context">
      @if (wsite.blocked) {
        <panel-section>
          <panel-section-title i18n="Blocked|Blocked">Blocked</panel-section-title>
          <panel-section-subtitle [matTooltip]="wsite.blockedAt | humanizeDate: 'precise'" matTooltipPosition="before">
            {{ wsite.blockedAt | timeAgo }}
          </panel-section-subtitle>
        </panel-section>
      }
      <panel-section>
        <panel-section-title i18n="Last seen|Last seen">Last seen</panel-section-title>
        <panel-section-subtitle [matTooltip]="wsite.lastSeen | humanizeDate: 'precise'" matTooltipPosition="before">
          {{ wsite.lastSeen | timeAgo }}
        </panel-section-subtitle>
      </panel-section>
      <panel-section>
        <panel-section-title i18n="First seen|First seen"> First seen </panel-section-title>
        <panel-section-subtitle [matTooltip]="wsite.createdAt | humanizeDate: 'precise'" matTooltipPosition="before">
          {{ wsite.createdAt | timeAgo }}
        </panel-section-subtitle>
      </panel-section>

      @if ((tagsSelectItems$ | async) && mergedTags$ | async; as websiteTags) {
        <panel-section>
          <panel-section-title i18n="Tags|The tags of an item"
            >Tags
            <span class="manage-tags-menu">
              â€”
              <app-text-select-menu
                [items]="tagsSelectItems$ | async"
                [buttonText]="manageTags"
                [filterText]="filterTags"
                [filterEnabled]="true"
                [colorEnabled]="true"
                [emptyText]="emptyTags"
                (itemSelection)="itemSelected($event)"
                [containerElement]="contextPanel"
              ></app-text-select-menu>
            </span>
          </panel-section-title>
          @if (website$ | async) {
            @if (!websiteTags.length && !newPillTag.isNew()) {
              <panel-section-subtitle i18n="No tags yet|There are no tags for this item"
                >No tags yet
              </panel-section-subtitle>
            }
            <div class="tw-pt-1 tw-flex tw-flex-wrap tw-gap-x-2 tw-gap-y-1">
              @for (tag of websiteTags; track tag) {
                <app-pill-tag [color]="(tags | whereId: [tag])?.color">{{
                  (tags | whereId: [tag])?.text
                }}</app-pill-tag>
              }
              <app-new-pill-tag #newPillTag [createdAtMilliseconds]="wsite.createdAt"></app-new-pill-tag>
            </div>
          }
        </panel-section>
      }

      <panel-section>
        <panel-section-title i18n="Website url|The url related to a website">Website</panel-section-title>
        <a [href]="wsite.url" target="_blank">{{ wsite.url }}</a>
      </panel-section>

      <panel-section>
        <panel-section-title i18n="Domain|The domain related to a website">Domain</panel-section-title>
        @if (wsite.domain) {
          <a [routerLink]="['/domains', wsite.domain.id]">{{ wsite.domain.name }}</a>
        } @else {
          <panel-section-subtitle i18n="No domain yet|There are no domains for this item"
            >No domain yet</panel-section-subtitle
          >
        }
      </panel-section>

      <panel-section>
        <panel-section-title i18n="Website IP|The ip related to a website">IP address</panel-section-title>
        <a [routerLink]="['/hosts', wsite.host.id]">{{ wsite.host.ip }}</a>
        @for (altHost of wsite.alternativeHosts; track altHost) {
          <a [routerLink]="['/hosts', altHost.id]">{{ altHost.ip }}</a>
        }
      </panel-section>

      <panel-section>
        <panel-section-title i18n="Website Port|Website port">Port</panel-section-title>

        <div>
          <a [routerLink]="['/ports', wsite.host.id, 'ports', wsite.port.port]">{{ wsite.port.port }}</a>
        </div>
      </panel-section>

      <panel-section>
        <panel-section-title i18n="Website path|Website port">Path</panel-section-title>

        <div>
          {{ wsite.path }}
        </div>
      </panel-section>

      <mat-divider></mat-divider>

      <panel-section>
        <panel-section-title i18n="Domain|The domain related to a website">Merged domains</panel-section-title>

        @for (altDomain of wsite.alternativeDomains; track altDomain) {
          <a [routerLink]="['/domains', altDomain.id]">{{ altDomain.name }}</a>
        }
        @if (!wsite.alternativeDomains || !wsite.alternativeDomains.length) {
          <panel-section-subtitle i18n="No domains yet|There are no domains for this item"
            >No domains yet</panel-section-subtitle
          >
        }
      </panel-section>

      <panel-section>
        <panel-section-title i18n="Merged hosts|A website's merged IP address">Merged hosts</panel-section-title>
        @if (hostPorts$ | async; as allHostPorts) {
          @if (allHostPorts.length > 5 && !showAllHosts ? allHostPorts.slice(0, 5) : allHostPorts; as hostPorts) {
            @for (hostPort of hostPorts; track hostPort) {
              <div class="host">
                <a [routerLink]="['/hosts', hostPort.hostSummary.id]">{{ hostPort.hostSummary.ip }}</a>
                @if (
                  showAllPorts[hostPort.hostSummary.ip] ? hostPort.websitePorts : hostPort.websitePorts.slice(0, 5);
                  as ports
                ) {
                  <ul class="ports">
                    @for (port of ports; track port; let last = $last) {
                      <li [routerLink]="['/hosts', hostPort.hostSummary.id, 'ports', port.port]">
                        <a>{{ port.port }}</a>
                      </li>
                    }
                  </ul>
                }
                @if (hostPort.websitePorts.length > 5) {
                  <div class="show-more">
                    <button panel-load-more (click)="showAllPorts[hostPort.hostSummary.ip] = true">
                      Show all ports ({{ hostPort.websitePorts.length }})
                    </button>
                  </div>
                }
              </div>
            }
          }
          @if (allHostPorts.length > 5) {
            <button panel-load-more (click)="showAllHosts = true">Show more ({{ allHostPorts.length }})</button>
          }
        } @else {
          <panel-section-subtitle i18n="No data yet|There is no data for this item">No data yet</panel-section-subtitle>
        }
      </panel-section>

      <mat-divider></mat-divider>

      <panel-section class="tw-opacity-60" #managementPanelSection>
        <app-text-menu [buttonText]="manageWebsiteText" [iconName]="'settings'" [xPosition]="'before'">
          <div class="tw-h-full tw-w-full tw-grid tw-gap-y-1">
            <button mat-menu-item class="tw-w-full" (click)="blockWebsite(!wsite.blocked)">
              <mat-icon>{{ wsite.blocked ? 'thumb_up' : 'block' }}</mat-icon>
              @if (wsite.blocked) {
                <label i18n="Unblock|Unblock an item">Unblock</label>
              } @else {
                <label i18n="Block|Block an item">Block</label>
              }
            </button>
            <button mat-menu-item color="warn" class="tw-w-full" (click)="deleteWebsite()">
              <mat-icon>delete</mat-icon>
              <label i18n="Delete|Delete an item">Delete</label>
            </button>
          </div>
        </app-text-menu>
      </panel-section>
    </div>
  </div>
}
