# Flow Manager

A NestJS TypeScript API that creates jobs, accepts job results and creates new jobs based on output and adds them to the Jobs Queue Handler. All results are tracked in the database.

It could be nice to eventually build a dashboard to be able to see in real time what is happening, the progress and the gathered information. Right now, the only real way to see the information gathered is to connect to the database with a MongoDB client.

An API key mechanism should be added in the future. Right now, this service has no authentication.

## Database

The Flow Manager uses MongoDB as its database for simplicity and its capacity to easily work with JSON objects and TypeScript. 

Mongoose is used to interact with the database.

## Jobs

A job consists of a task to do for the Job Handlers. They can be to find subdomains, to take a screenshot of a website, to try a check of a vulnerability, anything really. In the Flow Manager, jobs are stored in the database to keep track of them. The Flow Manager also accepts the outputs of the jobs to gather the information and react by creating new jobs, sending alerts, etc. 

|Field Name|Description|
|----------|-----------|
|id|A string uuid. It is used to reference the job in the database. It is passed all the way and back to know which job just finished.|
|priority|An integer, usually between 1 and 5. Used to prioritize jobs, 1 being the higher priority. Flow Manager usually sets 3 as a priority, but it can depend.|
|task|A string of the name of the task, simply past along with the job. The Job Handler uses the task name to determine what he has to do and what should be contained in the data object.|
|data|A JSON object, simply past along with the job. It contains the necessary information for the completion of the job in the Job Handlers|

## Programs

A program, in the Flow Manager, represents a Bug Bounty Program. Programs usually have allowed IP ranges as well as allowed domains. Therefore, the Program contains IP ranges and a domains array. See the "Domains" for more details.

## Domains

The domains are stored initially in the Programs, but every Domain object has its own subdomains array. It is stored in a Domain tree to be easily traversable and usable through recursivity.

Therefore, the following domains: 

sub1.example.com
sub2.example.com
sub4.example.com
sub7.sub4.example.com
sub8.sub4.example.com
sub5.example.com
sub3.example.com
sub6.sub3.example.com

Would be stored in a tree like this, where every node is a Domain object: 

```
example.com
|   sub1
|   sub2
|
└───sub4
|   |    sub7
|   |    sub8
|
└───sub5
|
└───sub3
    |   sub6
```

## Requests

Here are detailed the different requests that can be done on the Flow Manager API. 

### Create A Job

`POST /jobs/create`

Here, the priority 1 is given to be executed as soon as possible. The program name needs to be given to be stored properly in the database. For more information on Jobs, look at the Jobs section of this page. 

A uuid is generated by the backend and is returned by the server. You can use that uuid to track the job throughout its whole life.

```
{ 
    "task":"Example Task Name", 
    "program":"Example Program Name", 
    "priority":1, 
    "data":{}
}
```

### Get All Jobs

Lists all the ongoing jobs in the database.

`GET /jobs`

### Create A Program

Kind of the equivalent of creating a folder for a bug bounty program. Only requires the name of the program itself.

`POST /report/program`

```
{
    "name":"Example Program Name"
}
```

### Submit Found Domains

Submit the subdomains found in a job in the format of a string array. The JobId is required as a parameter to know which jobs it comes from. 

`POST /report/domains/{jobId}`

```
[
    "sub1.example.com",
    "sub2.example.com",
    "sub4.example.com",
    "sub7.sub4.example.com",
    "sub8.sub4.example.com",
    "sub5.example.com",
    "sub3.example.com",
    "sub6.sub3.example.com"
]
```